#!/bin/bash
# Local CI/CD pipeline for repo-backup
# Run this script before committing to ensure code quality

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

failures=0

run_step() {
    local name="$1"
    shift
    echo -e "\n${YELLOW}==> ${name}${NC}"
    if "$@"; then
        echo -e "${GREEN}OK ${name}${NC}"
    else
        echo -e "${RED}FAIL ${name}${NC}"
        ((failures++))
    fi
}

# Check we're in the right directory
if [[ ! -f "pyproject.toml" ]]; then
    echo -e "${RED}ERROR: Not in repo-backup project directory${NC}"
    exit 1
fi

echo -e "${YELLOW}Running CI for repo-backup${NC}"
echo "=========================================="

# Clean
rm -rf dist/ build/ *.egg-info/ .coverage htmlcov/ .pytest_cache/ .tmp/

# Sync
uv sync --extra dev --extra test

# Format check
run_step "black" uv run black src/ tests/ --check --diff
run_step "isort" uv run isort src/ tests/ --profile black --check-only --diff

# Security (ignore pip vulnerability - system package)
IGNORE_VULNS=""
if [[ -f ".pip-audit-ignore" ]]; then
    IGNORE_VULNS=$(grep -v '^#' .pip-audit-ignore | grep -v '^$' | tr '\n' ',' || true)
    IGNORE_VULNS="${IGNORE_VULNS%,}"
fi
if [[ -n "$IGNORE_VULNS" ]]; then
    run_step "pip-audit" uv run pip-audit --ignore-vuln "$IGNORE_VULNS"
else
    run_step "pip-audit" uv run pip-audit
fi

# Tests
TEST_COUNT=$(find tests/ -name "test_*.py" 2>/dev/null | wc -l)
if [[ "$TEST_COUNT" -gt 0 ]]; then
    # Clear tokens during tests
    export GITHUB_TOKEN_BACKUP="${GITHUB_TOKEN:-}"
    export GITLAB_TOKEN_BACKUP="${GITLAB_TOKEN:-}"
    export BITBUCKET_TOKEN_BACKUP="${BITBUCKET_TOKEN:-}"
    unset GITHUB_TOKEN GITLAB_TOKEN BITBUCKET_TOKEN 2>/dev/null || true

    run_step "pytest" uv run pytest tests/ -v --tb=short
    run_step "coverage" uv run pytest tests/ --cov=src --cov-report=term --cov-fail-under=15

    # Restore tokens
    export GITHUB_TOKEN="${GITHUB_TOKEN_BACKUP:-}"
    export GITLAB_TOKEN="${GITLAB_TOKEN_BACKUP:-}"
    export BITBUCKET_TOKEN="${BITBUCKET_TOKEN_BACKUP:-}"
else
    echo -e "${YELLOW}WARNING: No test files found${NC}"
fi

# Build
run_step "build" uv build

# Summary
echo ""
echo "=========================================="
if (( failures > 0 )); then
    echo -e "${RED}${failures} step(s) failed${NC}"
    exit 1
fi
echo -e "${GREEN}All CI checks passed${NC}"
